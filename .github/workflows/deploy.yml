name: Deploy Echo Bootcamp

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets
        shell: bash
        run: |
          set -euo pipefail
          [ -n "${{ secrets.VPS_HOST }}" ] || { echo "Missing secret: VPS_HOST"; exit 1; }
          [ -n "${{ secrets.VPS_PORT }}" ] || { echo "Missing secret: VPS_PORT"; exit 1; }
          [ -n "${{ secrets.VPS_USER }}" ] || { echo "Missing secret: VPS_USER"; exit 1; }
          [ -n "${{ secrets.VPS_SSH_KEY }}" ] || { echo "Missing secret: VPS_SSH_KEY"; exit 1; }
          [ -n "${{ secrets.VPS_KNOWN_HOSTS }}" ] || { echo "Missing secret: VPS_KNOWN_HOSTS"; exit 1; }

      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          printf '%s\n' "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          printf '%s\n' "${{ secrets.VPS_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy on VPS
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          set -euo pipefail
          ssh -p "$VPS_PORT" "$VPS_USER@$VPS_HOST" << 'EOF'
          set -euo pipefail

          APP_PATH=/var/www/echo-bootcamp
          APP_NAME=echo-bootcamp

          cd "$APP_PATH"
          git fetch origin
          git reset --hard origin/main

          npm ci
          npm run prisma:generate
          npm run prisma:deploy
          npm run build

          pm2 restart "$APP_NAME" --update-env
          pm2 save
          EOF

      - name: Deploy on VPS
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          set -euo pipefail

          ssh -p "$VPS_PORT" "$VPS_USER@$VPS_HOST" << 'EOF'
          set -euo pipefail

          APP_PATH=/var/www/echo-bootcamp
          APP_NAME=echo-bootcamp

          cd "$APP_PATH"

          # Pull latest
          git fetch origin
          git reset --hard origin/main

          # Build and migrate in correct order
          npm ci
          npm run prisma:generate
          npm run prisma:deploy
          npm run build

          # Restart app
          pm2 restart "$APP_NAME" --update-env
          pm2 save
          EOF

